{% extends "base.html" %}
{% load static %}

{% block content %}
<h2>Create Routine</h2>
<form method="post" id="routineForm">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit" class="btn btn-primary">Submit</button>
</form>
{% if warnings %}
    <div class="alert alert-warning">
        <ul>
            {% for warning in warnings %}
                <li>{{ warning }}</li>
            {% endfor %}
        </ul>
    </div>
{% endif %}

{% if messages %}
    <div class="alert alert-danger">
        {% for message in messages %}
            {{ message }}
        {% endfor %}
    </div>
{% endif %}

{% endblock %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    const form = document.getElementById('routineForm');
    form.addEventListener('submit', function(event) {
        const startTime = form.querySelector('input[name="start_time"]').value;
        const endTime = form.querySelector('input[name="end_time"]').value;
        const subject = form.querySelector('select[name="subject"]').value;
        const teacher = form.querySelector('select[name="teacher"]').value;
        const day = form.querySelector('select[name="day"]').value;

        if (!startTime || !endTime) {
            alert("Start time and end time must be set.");
            event.preventDefault();
            return;
        }

        const start = new Date('1970-01-01T' + startTime + 'Z');
        const end = new Date('1970-01-01T' + endTime + 'Z');
        const diffMs = end - start;
        const diffHrs = diffMs / (1000 * 60 * 60);

        if (start >= end) {
            alert("Start time must be before end time.");
            event.preventDefault();
            return;
        }

        if (diffHrs < 1 || diffHrs > 3) {
            alert("Class duration must be between 1 to 3 hours.");
            event.preventDefault();
            return;
        }

        const startHour = start.getUTCHours();
        const endHour = end.getUTCHours();
        if (startHour < 10 || endHour > 21) {
            alert("Class times must be between 10 AM and 9 PM.");
            event.preventDefault();
            return;
        }

        // Fetch existing routines for the same teacher and day via AJAX
        const xhr = new XMLHttpRequest();
        xhr.open('GET', `/routine/check_conflicts/?teacher=${teacher}&day=${day}`, false);
        xhr.send();

        if (xhr.status === 200) {
            const existingRoutines = JSON.parse(xhr.responseText);

            for (const routine of existingRoutines) {
                // Check if the same subject is already assigned on this day
                if (routine.subject == subject) {
                    alert("The same subject cannot be taken multiple times on the same day.");
                    event.preventDefault();
                    return;
                }

                // Check for overlapping time slots
                const existingStart = new Date('1970-01-01T' + routine.start_time + 'Z');
                const existingEnd = new Date('1970-01-01T' + routine.end_time + 'Z');

                if ((start < existingEnd && end > existingStart)) {
                    alert("There is a time conflict with another subject.");
                    event.preventDefault();
                    return;
                }
            }
        }
    });
});
</script>


